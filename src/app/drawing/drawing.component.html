<div class="relative h-screen overflow-hidden bg-gray-100">
  <div
    class="absolute top-0 left-0 w-full z-10 flex flex-column align-items-center p-3 pointer-events-none"
  >
    <div
      class="flex gap-2 bg-white shadow-4 border-round-xl p-2 pointer-events-auto align-items-center"
    >
      <button
        pButton
        icon="pi pi-bars"
        (click)="toggleSettings()"
        class="p-button-text p-button-plain"
        title="Toggle Settings"
      ></button>

      <div class="border-left-1 border-300 h-2rem mx-1"></div>

      <button
        pButton
        icon="pi pi-pencil"
        label="Pen 1"
        [class.p-button-outlined]="activeTool !== 'pen1'"
        (click)="activeTool = 'pen1'"
      ></button>
      <button
        pButton
        icon="pi pi-pencil"
        label="Pen 2"
        [class.p-button-outlined]="activeTool !== 'pen2'"
        (click)="activeTool = 'pen2'"
        class="p-button-secondary"
      ></button>
      <button
        pButton
        icon="pi pi-pencil"
        label="Highlighter"
        [class.p-button-outlined]="activeTool !== 'highlighter'"
        (click)="activeTool = 'highlighter'"
        class="p-button-help"
      ></button>
      <button
        pButton
        icon="pi pi-eraser"
        label="Eraser"
        [class.p-button-outlined]="activeTool !== 'eraser'"
        (click)="activeTool = 'eraser'"
        class="p-button-warning"
      ></button>

      <div class="border-left-1 border-300 h-2rem mx-2"></div>

      <button
        pButton
        icon="pi pi-chevron-left"
        (click)="undo()"
        [disabled]="allStrokes.length === 0"
        class="p-button-text p-button-plain"
        title="Undo"
      ></button>
      <button
        pButton
        icon="pi pi-chevron-right"
        (click)="redo()"
        [disabled]="redoStack.length === 0"
        class="p-button-text p-button-plain"
        title="Redo"
      ></button>

      <div class="border-left-1 border-300 h-2rem mx-1"></div>

      <button
        pButton
        icon="pi pi-upload"
        (click)="triggerUpload()"
        class="p-button-text p-button-plain"
        title="Upload SVG"
      ></button>
      <button
        pButton
        icon="pi pi-download"
        (click)="saveSVG()"
        class="p-button-text p-button-plain"
        title="Download SVG"
      ></button>
      <button
        pButton
        icon="pi pi-times"
        (click)="clearCanvas()"
        class="p-button-text p-button-danger"
        title="Clear All"
      ></button>

      <input
        id="svgUpload"
        type="file"
        accept=".svg"
        style="display: none"
        (change)="handleFileUpload($event)"
      />
    </div>

    <div
      *ngIf="activeTool !== 'eraser' && showSettings"
      class="mt-2 shadow-4 text-sm bg-white border-round-lg p-3 mx-1 pointer-events-auto w-18rem overflow-y-auto absolute top-0 left-0"
      style="max-height: 90vh; margin-top: 85px"
    >
      <div class="flex justify-content-between align-items-center mb-3">
        <span class="font-bold uppercase text-500"
          >{{ activeTool }} Settings</span
        >
        <button
          pButton
          icon="pi pi-refresh"
          label="Reset Pen"
          class="p-button-xs p-button-text p-button-secondary"
          (click)="resetPenSettings()"
        ></button>
      </div>

      <div class="flex flex-column gap-3 mb-4">
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Size</label>
          <input
            type="range"
            min="1"
            max="100"
            class="flex-grow-1"
            [(ngModel)]="tools[activeTool].size"
          />
          <span class="val w-2rem text-right">{{
            tools[activeTool].size
          }}</span>
        </div>
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Thinning</label>
          <input
            type="range"
            min="0"
            max="1"
            step="0.01"
            class="flex-grow-1"
            [(ngModel)]="tools[activeTool].thinning"
          />
          <span class="val w-2rem text-right">{{
            tools[activeTool].thinning
          }}</span>
        </div>
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Streamline</label>
          <input
            type="range"
            min="0"
            max="1"
            step="0.01"
            class="flex-grow-1"
            [(ngModel)]="tools[activeTool].streamline"
          />
          <span class="val w-2rem text-right">{{
            tools[activeTool].streamline
          }}</span>
        </div>
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Smoothing</label>
          <input
            type="range"
            min="0"
            max="1"
            step="0.01"
            class="flex-grow-1"
            [(ngModel)]="tools[activeTool].smoothing"
          />
          <span class="val w-2rem text-right">{{
            tools[activeTool].smoothing
          }}</span>
        </div>
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Easing</label>
          <select
            [(ngModel)]="tools[activeTool].easing"
            class="flex-grow-1 p-1"
          >
            <option *ngFor="let opt of easingOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>
      </div>

      <hr class="border-200" />

      <div class="flex flex-column gap-3 my-4">
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Taper Start</label>
          <input
            type="range"
            min="0"
            max="100"
            class="flex-grow-1"
            [(ngModel)]="tools[activeTool].start.taper"
          />
          <span class="val w-2rem text-right">{{
            tools[activeTool].start.taper
          }}</span>
        </div>
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Easing Start</label>
          <select
            [(ngModel)]="tools[activeTool].start.easing"
            class="flex-grow-1 p-1"
          >
            <option *ngFor="let opt of easingOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>
      </div>

      <hr class="border-200" />

      <div class="flex flex-column gap-3 my-4">
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Taper End</label>
          <input
            type="range"
            min="0"
            max="100"
            class="flex-grow-1"
            [(ngModel)]="tools[activeTool].end.taper"
          />
          <span class="val w-2rem text-right">{{
            tools[activeTool].end.taper
          }}</span>
        </div>
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Easing End</label>
          <select
            [(ngModel)]="tools[activeTool].end.easing"
            class="flex-grow-1 p-1"
          >
            <option *ngFor="let opt of easingOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>
      </div>

      <hr class="border-200" />

      <div class="flex flex-column gap-3 mt-4">
        <div class="flex align-items-center justify-content-between">
          <label>Fill Color</label>
          <input
            type="color"
            [(ngModel)]="tools[activeTool].color"
            class="w-3rem h-2rem border-none cursor-pointer"
          />
        </div>
        <div class="flex align-items-center gap-2">
          <label class="w-5rem">Stroke</label>
          <input
            type="range"
            min="0"
            max="100"
            class="flex-grow-1"
            [(ngModel)]="tools[activeTool].outline.width"
          />
          <span class="val w-2rem text-right">{{
            tools[activeTool].outline.width
          }}</span>
        </div>
        <div class="flex align-items-center justify-content-between">
          <label>Stroke Color</label>
          <input
            type="color"
            [(ngModel)]="tools[activeTool].outline.color"
            class="w-3rem h-2rem border-none cursor-pointer"
          />
        </div>
      </div>
    </div>
  </div>

  <svg
    #svgElement
    class="w-full h-full bg-white touch-none"
    (pointerdown)="onPointerDown($event)"
    (pointermove)="onPointerMove($event)"
    (pointerup)="onPointerUp()"
    (dragover)="$event.preventDefault()"
    (drop)="onFileDrop($event)"
  >
    <g *ngFor="let s of allStrokes">
      <path
        [attr.d]="s.path"
        [attr.fill]="s.color"
        [attr.fill-opacity]="s.opacity"
        [attr.stroke]="s.outlineColor"
        [attr.stroke-width]="s.outlineWidth"
        stroke-linejoin="round"
      />
    </g>
    <path
      *ngIf="previewPath"
      [attr.d]="previewPath"
      [attr.fill]="tools[activeTool].color"
      [attr.fill-opacity]="tools[activeTool].opacity"
      [attr.stroke]="tools[activeTool].outline.color"
      [attr.stroke-width]="tools[activeTool].outline.width"
      stroke-linejoin="round"
    />
  </svg>
</div>
